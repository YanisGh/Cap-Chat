<!DOCTYPE html>
<html>
<head>
  <title>Success Page</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    .container {
      margin-top: 50px;
    }
    .action-icon {
      cursor: pointer;
      margin-right: 10px;
    }
    .icon-edit,
    .icon-delete {
      width: 30px;
      height: 20px;
    }
    .thermometer {
      width: 400px;
      height: 20px;
      background-color: #f1f1f1;
      border: 1px solid #982424;
      position: relative;
      overflow: hidden;
    }

    #thermometerFill {
      width: 100%;
      height: 100%;
      background-color: #0080e1 !important;
      position: absolute;
      right: 0;  /* Align the right side of the fill element */
      transition: width 1s;  /* Change transition property to width */
    }


  </style>
</head>
<body>
  <div class="container">
    <h1>Login Successful</h1>
    <p>Welcome to the member's area!</p>
    <p id="demo"></p>
    <div class="btn-group">
      <button type="button" class="btn btn-primary" onclick="getAll('theme')">Voir les thèmes</button>
      <button type="button" class="btn btn-primary" onclick="getAll('artistes')">Voir les artistes</button>
      <button type="button" class="btn btn-primary" onclick="getAll('jeux d\'image')">Voir les jeux d'image</button>
      <button type="button" class="btn btn-primary" onclick="showForm()">Ajouter un jeu d'image</button>
      <button onclick="startCaptchaGame()">Test Captcha Game</button>
    </div>
    <div id="formContainer" style="display: none;">
      <form id="myForm">
        <label for="username">Username:</label>
        <input type="text" id="username" name="username"><br><br>
    
        <label for="captchatName">CaptChat Name:</label>
        <input type="text" id="captchatName" name="captchatName"><br><br>
    
        <label for="theme">Theme:</label>
        <select id="theme" name="theme"></select>

        <script>
          // Function to populate the select dropdown with themes
          function populateThemes() {
          var xhttp = new XMLHttpRequest();
          var url = 'http://localhost:3000/getAll?categorie=theme';
          xhttp.open('GET', url, true);
          xhttp.send();
          xhttp.onreadystatechange = function() {
            if (this.readyState == 4) {
              if (this.status == 200) {
                var response = JSON.parse(this.responseText);
                var select = document.getElementById('theme');

                // Clear existing options
                select.innerHTML = '';

                // Add theme options
                response.forEach(function(theme) {
                  var option = document.createElement('option');
                  option.value = theme.idTheme;
                  option.textContent = theme.Nom;
                  select.appendChild(option);
                });
              } else {
                document.getElementById('demo').innerHTML = 'Error: ' + this.status;
              }
            }
          };
        }

        // Call the populateThemes function to fetch and populate the themes
        populateThemes();
        </script>
        </select><br><br>
    
        <label for="neutralPics">Neutral Pics (.zip):</label>
        <input type="file" id="neutralPics" name="neutralPics" accept=".zip"><br><br>
    
        <label for="singularPic">Singular Pic (.zip):</label>
        <input type="file" id="singularPic" name="singularPic" accept=".zip"><br><br>
    
        <label for="singularPicHint">Singular Pic Hint:</label><br>
        <input type="text" id="singularPicHint" name="singularPicHint"><br><br>

      </form>
      <button onclick="submitForm()">Submit</button>
    </div>

      <div id="content" class="mt-4"></div>
      <div id="thermometerContainer" class="thermometer">
        <div id="thermometerFill"></div>
      </div>
      
      <div id="timer" class="mt-4"></div>
      
      <div id="imageContainer" class="mt-4"></div>
  </div>

  <script>
    function getAll(categorie) {
      formContainer.style.display = "none";
      var xhttp = new XMLHttpRequest();
      var url = `http://localhost:3000/getAll?categorie=${categorie}`;
      xhttp.open("GET", url, true);
      xhttp.send();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4) {
          if (this.status == 200) {
            var response = JSON.parse(this.responseText);
            var contentContainer = document.getElementById("content");
            // Generate table HTML
            var tableHTML = '<table class="table"><thead><tr><th>ID</th><th>' + categorie + '</th><th>Actions</th></tr></thead><tbody>';
              for (var i = 0; i < response.length; i++) {
                var item = response[i];
                var itemId, itemName;

                if (categorie === 'artistes') {
                  itemId = item.idUtilisateur;
                  itemName = item.Identifiant;
                } else if (categorie === 'jeux d\'image') {
                  itemId = item.idJeu;
                  itemName = item.Nom;
                } else if (categorie === 'theme') {
                  itemId = item.idTheme;
                  itemName = item.Nom;
                }

                  tableHTML += '<tr id="row-' + itemId + '"><td>' + itemId + '</td><td class="item-name">' + itemName + '</td><td>' +
                  '<span id="button-container-' + itemId + '">' +
                    //Replace the ' with \ to avoid it breaking the syntax when the category is sent in the functions
                    '<img src="img/logo/edit.png" alt="modif" class="action-icon icon-edit" onclick="modifyAll(\'' + categorie.replace("'", "\\'") + '\', ' + itemId + ')">' +
                    '<img src="img/logo/bin.png" alt="supp" class="action-icon icon-delete" onclick="deleteAll(\'' + categorie.replace("'", "\\'") + '\', ' + itemId + ')">' +
                  '</span>' +
                  '</td></tr>';
                  }
            tableHTML += '</tbody></table>';

            contentContainer.innerHTML = tableHTML;
          } else {
            document.getElementById("demo").innerHTML = 'Error: ' + this.status;
          }
        }
      };
    }

    function showForm() {
      var formContainer = document.getElementById("formContainer");
      if (formContainer.style.display === "none") {
        formContainer.style.display = "block";
      } else {
        formContainer.style.display = "none";
      }
    }

    function submitForm() {
    var form = document.getElementById("myForm");
    var formData = new FormData(form);

    var themeSelect = document.getElementById("theme");
    var selectedTheme = themeSelect.options[themeSelect.selectedIndex];
    
    // Add theme ID and name to the form data
    formData.append("themeId", selectedTheme.value);
    formData.append("themeName", selectedTheme.textContent);

    var url = 'http://localhost:3000/postForm';
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        var response = JSON.parse(this.responseText);
        // Handle the response from the server
        console.log(response);
      }
    };

    xhttp.open("POST", url, true);
    xhttp.send(formData);
}


    function deleteAll(categorie, index) {
      var xhttp = new XMLHttpRequest();
      var url = `http://localhost:3000/deleteAll?categorie=${categorie}&id=${index}`;
      xhttp.open("DELETE", url, true);
      xhttp.send();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4) {
          if (this.status == 200) {
            //document.getElementById("demo").innerHTML = categorie + ' supprimer avec succès !';
            alert(categorie + ' supprimer avec succès !');
            getAll(categorie);
          } else {
            document.getElementById("demo").innerHTML = 'Error: ' + this.status;
          }
        }
      };
    }

    function modifyAll(categorie, index) {
      var row = document.getElementById('row-' + index);
      if (!row) {
        console.error("Row not found.");
        return;
      }

      var itemNameElement = row.querySelector('.item-name');
      if (!itemNameElement) {
        console.error("Item name element not found.");
        return;
      }

      var itemName = itemNameElement.innerText;

      // Create textarea element
      var textarea = document.createElement('textarea');
      textarea.setAttribute('id', 'textarea-' + index);
      textarea.value = itemName;

      // Replace item name column with textarea
      itemNameElement.innerHTML = '';
      itemNameElement.appendChild(textarea);

      // Change button text and onclick function
      var buttonContainer = document.getElementById('button-container-' + index);
      if (buttonContainer) {
        buttonContainer.innerHTML = '';
        var confirmButton = document.createElement('img');
        confirmButton.setAttribute('src', 'img/logo/check.png');
        confirmButton.setAttribute('alt', 'confirm');
        confirmButton.classList.add('action-icon', 'icon-edit');
        confirmButton.onclick = function() {
          confirmEdit(categorie, index);
        };
        buttonContainer.appendChild(confirmButton);
      }
    }

    function confirmEdit(categorie, index) {
      var row = document.getElementById('row-' + index);
      if (!row) {
        console.error("Row not found.");
        return;
      }

      var itemNameElement = row.querySelector('.item-name');
      if (!itemNameElement) {
        console.error("Item name element not found.");
        return;
      }

      var textarea = document.getElementById('textarea-' + index);
      var newName = textarea.value;

      var xhttp = new XMLHttpRequest();
      var url = 'http://localhost:3000/modifyAll';
      xhttp.open('PATCH', url, true);
      xhttp.setRequestHeader('Content-type', 'application/json');
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4) {
          if (this.status == 200) {
            alert(categorie + 'modified successfully');
            // Refresh the table or perform any other necessary action
            getAll(categorie);
          } else {
            console.error('Error modifying' + categorie +' :', this.responseText);
          }
        }
      };
      var data = JSON.stringify({
        categorie: categorie,
        id: index,
        newName: newName
      });
      xhttp.send(data);
  }

  function startCaptchaGame() {
  // Send a GET request to the CAPTCHA route
  var xhttp = new XMLHttpRequest();
  var url = 'http://localhost:3000/captcha/5';
  xhttp.open('GET', url, true);
  xhttp.send();

  // Handle the response
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var response = JSON.parse(this.responseText);
      var captchaData = response.captchaData;
      var timer = 30; // Initial timer value in seconds

      // Clear the previous images and timer
      var imageContainer = document.getElementById('imageContainer');
      imageContainer.innerHTML = '';
      clearInterval(timerInterval);

      // Display the neutral images using the image URLs in captchaData
      captchaData.neutralImages.forEach(function(imageUrl) {
        var img = createImageElement(imageUrl, 'neutres');
        img.addEventListener('click', function() {
          timer -= 5; // Deduct 5 seconds for non-singular image click
        });
        imageContainer.appendChild(img);
      });

      // Display the singular image using the image URL in captchaData
      var singularImg = createImageElement(captchaData.singularImage.NomIMG, 'singuliers');
      singularImg.addEventListener('click', function() {
        alert('Captcha validé');
        clearInterval(timerInterval);
        imageContainer.innerHTML = ''
        timerDisplay.textContent = '';
        thermometerContainer.style.display = 'none';
      });
      imageContainer.appendChild(singularImg);

      // Apply CSS Styling for arranging images in a 4x4 grid
      var imgContainers = imageContainer.getElementsByTagName('img');
      for (var i = 0; i < imgContainers.length; i++) {
        imgContainers[i].style.margin = '5px';
        imgContainers[i].style.width = '50px';
        imgContainers[i].style.height = '50px';
        imgContainers[i].style.display = 'block';
        imgContainers[i].style.float = 'left';
      }

      // Update the timer display every second
      var timerDisplay = document.getElementById('timer');
      timerDisplay.textContent = 'Time left: ' + timer + 's';
      var timerInterval = setInterval(function() {
        timer--;
        timerDisplay.textContent = 'Time left: ' + timer + 's';

        if (timer <= 0) {
          clearInterval(timerInterval);
          alert('You ran out of time');
          imageContainer.innerHTML = '';
          timerDisplay.textContent = '';
          thermometerContainer.style.display = 'none';
        }

        // Calculate the percentage of remaining time
        var percentage = (timer / 30) * 100; // Adjust based on your timer range

        // Update the thermometer fill based on the percentage
        updateThermometerFill(percentage);
      }, 1000);

      // Function to update the thermometer fill based on the percentage
      function updateThermometerFill(percentage) {
      var fillElement = document.getElementById('thermometerFill');
      fillElement.style.width = percentage + '%';  // Update width instead of height
    }

      // Example usage:
      // Update the thermometer fill with a percentage between 0 and 100
      var percentage = (timer / 30) * 100; // Adjust based on your timer range
      updateThermometerFill(percentage);
    }
  };
}





  // Helper function to create an image element
  function createImageElement(imageUrl, folder) {
    var img = document.createElement('img');
    img.src = 'captchaIMG/' + folder + '/' + imageUrl;
    return img;
}








    // function logIndex(index) {
    //   console.log("Clicked on row index:", index);
    // }

    document.addEventListener('DOMContentLoaded', function() {
      var urlParams = new URLSearchParams(window.location.search);
      var token = urlParams.get('token');
      if (!token) {
        window.location.href = 'index.html';
      }
    });
  </script>
</body>
</html>
